from datetime import timedelta
from io import StringIO

import pandas as pd

# Вхідні дані: Цінова політика
pricing_data = """
season,date_from,date_to,weekday_price,weekend_price
high,2024-01-01,2024-02-29,7000,8500
low,2024-03-01,2024-05-31,6000,7500
high,2024-06-01,2024-08-31,7000,8500
low,2024-09-01,2024-11-30,6000,7500
high,2024-12-01,2024-12-31,7000,8500
"""

# 1. Завантаження даних
# Читаємо bookings_old.csv
df_bookings = pd.read_csv(StringIO("""booking_id,customer_id,check_in,check_out,nights,total_price
1,72,2024-01-01,2024-01-04,3,18000
2,87,2024-01-02,2024-01-05,3,18000
3,22,2024-01-03,2024-01-06,3,18000
4,38,2024-01-04,2024-01-06,2,12000
5,76,2024-01-05,2024-01-06,1,6000
6,49,2024-01-06,2024-01-07,1,7500
7,62,2024-01-07,2024-01-10,3,19500
8,116,2024-01-08,2024-01-11,3,18000
9,7,2024-01-09,2024-01-12,3,18000
10,60,2024-01-10,2024-01-11,1,6000
11,53,2024-01-11,2024-01-13,2,12000
12,44,2024-01-12,2024-01-15,3,21000
13,81,2024-01-13,2024-01-15,2,15000
14,6,2024-01-14,2024-01-16,2,13500
15,63,2024-01-15,2024-01-16,1,6000
16,48,2024-01-17,2024-01-20,3,18000
17,62,2024-01-18,2024-01-19,1,6000
18,111,2024-01-19,2024-01-21,2,13500
19,29,2024-01-21,2024-01-22,1,7500
20,115,2024-01-24,2024-01-27,3,18000
21,5,2024-01-25,2024-01-26,1,6000
22,23,2024-01-28,2024-01-31,3,19500
23,91,2024-01-29,2024-01-31,2,12000
24,78,2024-01-30,2024-02-02,3,18000
25,9,2024-02-01,2024-02-04,3,19500
26,113,2024-02-03,2024-02-06,3,21000
27,101,2024-02-04,2024-02-06,2,13500
28,29,2024-02-05,2024-02-08,3,18000
29,115,2024-02-06,2024-02-09,3,18000
30,62,2024-02-07,2024-02-08,1,6000
31,62,2024-02-08,2024-02-10,2,12000
32,103,2024-02-09,2024-02-10,1,6000
33,105,2024-02-11,2024-02-12,1,7500
34,9,2024-02-12,2024-02-15,3,18000
35,44,2024-02-13,2024-02-15,2,12000
36,52,2024-02-14,2024-02-15,1,6000
37,39,2024-02-15,2024-02-17,2,12000
38,56,2024-02-16,2024-02-17,1,6000
39,92,2024-02-17,2024-02-19,2,15000
40,1,2024-02-18,2024-02-19,1,7500
41,32,2024-02-19,2024-02-21,2,12000
42,75,2024-02-20,2024-02-23,3,18000
43,24,2024-02-21,2024-02-23,2,12000
44,11,2024-02-22,2024-02-24,2,12000
45,3,2024-02-24,2024-02-25,1,7500
46,90,2024-02-25,2024-02-28,3,19500
47,52,2024-02-26,2024-02-29,3,18000
48,92,2024-02-28,2024-03-02,3,18000
49,16,2024-03-01,2024-03-04,3,21000
50,12,2024-03-03,2024-03-05,2,13500
51,9,2024-03-04,2024-03-07,3,18000
52,20,2024-03-05,2024-03-08,3,18000
53,104,2024-03-07,2024-03-09,2,12000
54,89,2024-03-08,2024-03-10,2,13500
55,82,2024-03-09,2024-03-11,2,15000
56,41,2024-03-10,2024-03-11,1,7500
57,21,2024-03-11,2024-03-13,2,12000
58,67,2024-03-12,2024-03-15,3,18000
59,115,2024-03-13,2024-03-16,3,18000
60,38,2024-03-14,2024-03-16,2,12000
61,64,2024-03-17,2024-03-20,3,19500
62,17,2024-03-19,2024-03-20,1,6000
63,37,2024-03-21,2024-03-22,1,6000
64,18,2024-03-25,2024-03-28,3,18000
65,67,2024-03-26,2024-03-28,2,12000
66,86,2024-03-27,2024-03-30,3,18000
67,2,2024-03-28,2024-03-30,2,12000
68,43,2024-03-29,2024-03-30,1,6000
69,119,2024-03-30,2024-04-01,2,15000
70,60,2024-03-31,2024-04-01,1,7500
71,20,2024-04-01,2024-04-02,1,6000
72,76,2024-04-02,2024-04-04,2,12000
73,86,2024-04-04,2024-04-07,3,19500
74,22,2024-04-05,2024-04-07,2,13500
75,70,2024-04-06,2024-04-08,2,15000
76,97,2024-04-07,2024-04-08,1,7500
77,114,2024-04-11,2024-04-12,1,6000
78,120,2024-04-12,2024-04-13,1,6000
79,90,2024-04-13,2024-04-16,3,21000
80,9,2024-04-14,2024-04-17,3,19500
81,1,2024-04-15,2024-04-17,2,12000
82,48,2024-04-16,2024-04-18,2,12000
83,16,2024-04-17,2024-04-18,1,6000
84,22,2024-04-18,2024-04-19,1,6000
85,57,2024-04-20,2024-04-22,2,15000
86,113,2024-04-21,2024-04-24,3,19500
87,76,2024-04-22,2024-04-23,1,6000
88,39,2024-04-23,2024-04-24,1,6000
89,23,2024-04-24,2024-04-25,1,6000
90,52,2024-04-25,2024-04-27,2,12000
91,96,2024-04-26,2024-04-28,2,13500
92,2,2024-04-28,2024-05-01,3,19500
93,84,2024-04-29,2024-05-02,3,18000
94,33,2024-04-30,2024-05-01,1,6000
95,43,2024-05-02,2024-05-04,2,12000
96,46,2024-05-03,2024-05-06,3,21000
97,87,2024-05-04,2024-05-07,3,21000
98,74,2024-05-05,2024-05-07,2,13500
99,7,2024-05-06,2024-05-07,1,6000
100,75,2024-05-07,2024-05-08,1,6000
101,49,2024-05-10,2024-05-13,3,21000
102,62,2024-05-12,2024-05-15,3,19500
103,13,2024-05-13,2024-05-16,3,18000
104,86,2024-05-15,2024-05-16,1,6000
105,105,2024-05-16,2024-05-17,1,6000
106,69,2024-05-19,2024-05-20,1,7500
107,85,2024-05-20,2024-05-23,3,18000
108,5,2024-05-23,2024-05-26,3,19500
109,74,2024-05-25,2024-05-26,1,7500
110,66,2024-05-28,2024-05-31,3,18000
111,8,2024-05-29,2024-06-01,3,18000
112,71,2024-05-30,2024-05-31,1,6000
113,108,2024-06-01,2024-06-02,1,8500
114,19,2024-06-02,2024-06-04,2,15500
115,114,2024-06-03,2024-06-04,1,7000
116,105,2024-06-04,2024-06-05,1,7000
117,25,2024-06-06,2024-06-07,1,7000
118,47,2024-06-12,2024-06-14,2,14000
119,1,2024-06-13,2024-06-16,3,22500
120,57,2024-06-14,2024-06-17,3,24000
121,8,2024-06-16,2024-06-17,1,8500
122,60,2024-06-17,2024-06-19,2,14000
123,100,2024-06-18,2024-06-19,1,7000
124,92,2024-06-20,2024-06-21,1,7000
125,6,2024-06-21,2024-06-24,3,24000
126,114,2024-06-23,2024-06-25,2,15500
127,118,2024-06-24,2024-06-25,1,7000
128,89,2024-06-26,2024-06-29,3,21000
129,6,2024-06-29,2024-07-02,3,24000
130,102,2024-06-30,2024-07-01,1,8500
131,17,2024-07-02,2024-07-05,3,21000
132,51,2024-07-03,2024-07-04,1,7000
133,113,2024-07-04,2024-07-05,1,7000
134,34,2024-07-06,2024-07-08,2,17000
135,12,2024-07-07,2024-07-09,2,15500
136,112,2024-07-09,2024-07-10,1,7000
137,85,2024-07-10,2024-07-11,1,7000
138,38,2024-07-11,2024-07-14,3,22500
139,98,2024-07-12,2024-07-14,2,15500
140,63,2024-07-13,2024-07-16,3,24000
141,88,2024-07-14,2024-07-15,1,8500
142,4,2024-07-16,2024-07-17,1,7000
143,84,2024-07-17,2024-07-18,1,7000
144,66,2024-07-18,2024-07-19,1,7000
145,115,2024-07-19,2024-07-22,3,24000
146,75,2024-07-20,2024-07-23,3,24000
147,67,2024-07-21,2024-07-22,1,8500
148,92,2024-07-24,2024-07-26,2,14000
149,1,2024-07-25,2024-07-27,2,14000
150,34,2024-07-26,2024-07-28,2,15500
151,73,2024-07-27,2024-07-30,3,24000
152,111,2024-07-28,2024-07-30,2,15500
153,81,2024-07-29,2024-07-30,1,7000
154,99,2024-07-30,2024-07-31,1,7000
155,56,2024-07-31,2024-08-03,3,21000
156,78,2024-08-01,2024-08-04,3,22500
157,59,2024-08-02,2024-08-04,2,15500
158,23,2024-08-03,2024-08-06,3,24000
159,18,2024-08-04,2024-08-05,1,8500
160,64,2024-08-05,2024-08-08,3,21000
161,39,2024-08-06,2024-08-08,2,14000
162,44,2024-08-07,2024-08-09,2,14000
163,68,2024-08-08,2024-08-09,1,7000
164,111,2024-08-09,2024-08-11,2,15500
165,8,2024-08-10,2024-08-13,3,24000
166,41,2024-08-11,2024-08-13,2,15500
167,59,2024-08-12,2024-08-14,2,14000
168,33,2024-08-13,2024-08-14,1,7000
169,119,2024-08-14,2024-08-16,2,14000
170,62,2024-08-15,2024-08-17,2,14000
171,6,2024-08-18,2024-08-21,3,22500
172,6,2024-08-19,2024-08-22,3,21000
173,79,2024-08-21,2024-08-23,2,14000
174,44,2024-08-22,2024-08-23,1,7000
175,84,2024-08-23,2024-08-26,3,24000
176,1,2024-08-24,2024-08-27,3,24000
177,11,2024-08-25,2024-08-26,1,8500
178,5,2024-08-27,2024-08-29,2,14000
179,40,2024-08-28,2024-08-29,1,7000
180,15,2024-08-30,2024-09-02,3,24000
181,95,2024-08-31,2024-09-02,2,17000
182,35,2024-09-03,2024-09-06,3,18000
183,105,2024-09-05,2024-09-08,3,19500
184,4,2024-09-08,2024-09-10,2,13500
185,40,2024-09-09,2024-09-11,2,12000
186,38,2024-09-10,2024-09-13,3,18000
187,25,2024-09-11,2024-09-12,1,6000
188,78,2024-09-12,2024-09-14,2,12000
189,51,2024-09-13,2024-09-16,3,21000
190,72,2024-09-14,2024-09-17,3,21000
191,29,2024-09-15,2024-09-18,3,19500
192,36,2024-09-16,2024-09-19,3,18000
193,68,2024-09-18,2024-09-19,1,6000
194,74,2024-09-19,2024-09-22,3,19500
195,47,2024-09-20,2024-09-23,3,21000
196,29,2024-09-22,2024-09-23,1,7500
197,27,2024-09-23,2024-09-25,2,12000
198,43,2024-09-24,2024-09-26,2,12000
199,74,2024-09-25,2024-09-27,2,12000
200,47,2024-09-26,2024-09-29,3,19500
201,13,2024-09-27,2024-09-29,2,13500
202,111,2024-09-28,2024-09-29,1,7500
203,120,2024-09-29,2024-09-30,1,7500
204,92,2024-09-30,2024-10-01,1,6000
205,29,2024-10-01,2024-10-04,3,18000
206,23,2024-10-02,2024-10-05,3,18000
207,110,2024-10-03,2024-10-05,2,12000
208,63,2024-10-04,2024-10-05,1,6000
209,21,2024-10-05,2024-10-08,3,21000
210,52,2024-10-06,2024-10-08,2,13500
211,75,2024-10-08,2024-10-10,2,12000
212,59,2024-10-10,2024-10-13,3,19500
213,71,2024-10-11,2024-10-12,1,6000
214,49,2024-10-12,2024-10-13,1,7500
215,71,2024-10-14,2024-10-15,1,6000
216,61,2024-10-16,2024-10-19,3,18000
217,94,2024-10-17,2024-10-18,1,6000
218,16,2024-10-20,2024-10-22,2,13500
219,115,2024-10-21,2024-10-23,2,12000
220,114,2024-10-22,2024-10-23,1,6000
221,8,2024-10-23,2024-10-24,1,6000
222,34,2024-10-25,2024-10-27,2,13500
223,7,2024-10-26,2024-10-28,2,15000
224,67,2024-10-27,2024-10-30,3,19500
225,72,2024-10-28,2024-10-29,1,6000
226,51,2024-10-29,2024-11-01,3,18000
227,35,2024-10-30,2024-11-01,2,12000
228,107,2024-10-31,2024-11-02,2,12000
229,48,2024-11-02,2024-11-05,3,21000
230,23,2024-11-03,2024-11-04,1,7500
231,20,2024-11-06,2024-11-07,1,6000
232,87,2024-11-07,2024-11-10,3,19500
233,38,2024-11-08,2024-11-09,1,6000
234,110,2024-11-12,2024-11-15,3,18000
235,115,2024-11-13,2024-11-15,2,12000
236,109,2024-11-14,2024-11-16,2,12000
237,107,2024-11-15,2024-11-17,2,13500
238,109,2024-11-16,2024-11-17,1,7500
239,18,2024-11-17,2024-11-19,2,13500
240,38,2024-11-18,2024-11-19,1,6000
241,76,2024-11-19,2024-11-21,2,12000
242,27,2024-11-20,2024-11-21,1,6000
243,53,2024-11-22,2024-11-23,1,6000
244,85,2024-11-23,2024-11-25,2,15000
245,54,2024-11-24,2024-11-26,2,13500
246,11,2024-11-26,2024-11-27,1,6000
247,59,2024-11-27,2024-11-28,1,6000
248,55,2024-11-28,2024-11-30,2,12000
249,56,2024-11-29,2024-11-30,1,6000
250,99,2024-11-30,2024-12-03,3,21000
251,73,2024-12-03,2024-12-04,1,6000
252,43,2024-12-04,2024-12-05,1,6000
253,3,2024-12-05,2024-12-08,3,19500
254,94,2024-12-06,2024-12-09,3,21000
255,44,2024-12-07,2024-12-08,1,7500
256,8,2024-12-10,2024-12-13,3,18000
257,118,2024-12-11,2024-12-12,1,6000
258,89,2024-12-12,2024-12-14,2,12000
259,109,2024-12-13,2024-12-14,1,6000
260,17,2024-12-14,2024-12-17,3,21000
261,7,2024-12-15,2024-12-17,2,13500
262,115,2024-12-16,2024-12-17,1,6000
263,14,2024-12-20,2024-12-21,1,6000
264,98,2024-12-21,2024-12-22,1,7500
265,15,2024-12-23,2024-12-26,3,18000
266,16,2024-12-25,2024-12-26,1,6000
267,55,2024-12-26,2024-12-28,2,12000
268,119,2024-12-27,2024-12-30,3,21000
269,39,2024-12-28,2024-12-31,3,21000
270,93,2024-12-29,2024-12-30,1,7500
271,10,2024-12-30,2025-01-02,3,18000
272,65,2024-12-31,2025-01-01,1,6000
"""))
df_pricing = pd.read_csv(StringIO(pricing_data))

# 2. Підготовка даних
df_bookings['check_in'] = pd.to_datetime(df_bookings['check_in']).dt.date
df_bookings['check_out'] = pd.to_datetime(df_bookings['check_out']).dt.date
df_pricing['date_from'] = pd.to_datetime(df_pricing['date_from']).dt.date
df_pricing['date_to'] = pd.to_datetime(df_pricing['date_to']).dt.date


def get_day_price(current_date):
    """
    Повертає ціну на одну ніч для даної дати, виходячи з сезону та дня тижня.
    """
    # 0=Понеділок, 6=Неділя
    is_weekend = current_date.weekday() >= 5

    # Знаходимо відповідний сезон
    price_row = df_pricing[
        (df_pricing['date_from'] <= current_date) &
        (df_pricing['date_to'] >= current_date)
        ]

    if price_row.empty:
        # Якщо ціна не знайдена (поза ціновими діапазонами), встановлюємо 0
        return 0

    price_row = price_row.iloc[0]

    if is_weekend:
        return price_row['weekend_price']
    else:
        return price_row['weekday_price']


def calculate_new_price(row):
    """Обчислює загальну вартість бронювання."""
    check_in = row['check_in']
    check_out = row['check_out']

    total_new_price = 0
    current_date = check_in

    # Ітерація по кожній ночі
    while current_date < check_out:
        total_new_price += get_day_price(current_date)
        current_date += timedelta(days=1)

    return round(total_new_price, 2)


# 3. Перерахунок цін
df_bookings['total_price'] = df_bookings.apply(calculate_new_price, axis=1)

# 4. Збереження оновленого файлу
UPDATED_FILE_NAME = '../rental_house/bookings.csv'
df_bookings.to_csv(UPDATED_FILE_NAME, index=False)

# Виведення результату
print(f"✅ Перерахунок завершено. Оновлені дані збережено у файлі: '{UPDATED_FILE_NAME}'")
print("\n### Перші 10 оновлених записів (Порівняння з новим pricing) ###")
print(df_bookings.head(10).to_markdown(index=False))
